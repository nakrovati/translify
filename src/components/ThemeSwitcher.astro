---
import PhDesktop from "@assets/icons/PhDesktop.astro";
import PhMoon from "@assets/icons/PhMoon.astro";
import PhSun from "@assets/icons/PhSun.astro";
---

<details class="dropdown dropdown-end" id="theme-switcher">
  <summary class="btn btn-ghost btn-circle m-1">
    <PhDesktop class="ph-desktop size-5" />
    <PhMoon class="ph-moon hidden size-5" />
    <PhSun class="ph-sun hidden size-5" />
  </summary>
  <ul
    class="menu dropdown-content bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm"
  >
    <li><button data-select-theme="light">Light</button></li>
    <li><button data-select-theme="dark">Dark</button></li>
    <li><button data-select-theme="system">System</button></li>
  </ul>
</details>

<script>
  const StorageKey = "translify:theme";

  const selectThemeButtons = document.querySelectorAll<HTMLButtonElement>(
    "[data-select-theme]",
  );

  const lightIcon = document.querySelector<SVGElement>(".ph-sun")!;
  const darkIcon = document.querySelector<SVGElement>(".ph-moon")!;
  const desktopIcon = document.querySelector<SVGElement>(".ph-desktop")!;

  globalThis.addEventListener("DOMContentLoaded", () => {
    initTheme();
    setupThemeButtons();
  });

  function applySystemTheme() {
    const prefersDark = globalThis.matchMedia(
      "(prefers-color-scheme: dark)",
    ).matches;

    document.documentElement.dataset.theme = prefersDark ? "dark" : "light";
  }

  function handleSystemThemeChange() {
    if (localStorage.getItem(StorageKey) === "system") {
      applySystemTheme();
    }
  }

  function initTheme() {
    const savedTheme = localStorage.getItem(StorageKey) || "system";
    setTheme(savedTheme);
    setupWindowColorSchemeListener();
  }

  function setTheme(theme: string) {
    if (theme === "system") {
      applySystemTheme();
    } else {
      document.documentElement.dataset.theme = theme;
    }
    localStorage.setItem(StorageKey, theme);

    updateActiveThemeButton(theme);
    updateIcons(theme);
  }

  function setupThemeButtons() {
    for (const button of selectThemeButtons) {
      button.addEventListener("click", () => {
        setTheme(button.dataset.selectTheme!);
      });
    }
  }

  function setupWindowColorSchemeListener() {
    globalThis
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", handleSystemThemeChange);
  }

  function updateActiveThemeButton(theme: string) {
    for (const button of selectThemeButtons) {
      button.classList.toggle(
        "menu-active",
        button.dataset.selectTheme === theme,
      );
    }
  }

  function updateIcons(theme: string) {
    lightIcon.classList.toggle("hidden", theme !== "light");
    darkIcon.classList.toggle("hidden", theme !== "dark");
    desktopIcon.classList.toggle("hidden", theme !== "system");
  }
</script>
